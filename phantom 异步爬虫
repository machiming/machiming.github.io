var express = require('express');
var router = express.Router();
var request = require("request");
var cheerio = require("cheerio");
var phantom = require('phantom');
var fs = require("fs");
var bugUrl = 'http://s.weibo.com/top/summary?cate=realtimehot';

router.get('/',function (req,res,next) {
    (async function() {
        var data = [];

        // await解决回调问题，创建一个phantom实例
        const instance = await phantom.create();
        //通过phantom实例创建一个page对象，page对象可以理解成一个对页面发起请求和处理结果这一集合的对象
        const page = await instance.createPage();
        //页面指向的是哪个一个url
        await page.on("onResourceRequested", function(requestData) {
            //console.info('Requesting', requestData.url)
        });
        //得到打开该页面的状态码
        const status = await page.open(bugUrl);
        console.log(status)
        //输出该页面的内容
        const content = await page.property('content');
        var $ = cheerio.load(content);
        var navText = $('#realtimehot tbody tr');
        if (navText.length > 0) {
            Array.from(navText).forEach(function (value) {
                var url = "http://s.weibo.com"+$(value).find(".star_name a").attr("href");
                var name = $(value).find(".star_name a").text();
                var hotPoint=$(value).find(".star_num span").text()
               if (parseInt(hotPoint)>0){
                   data.push({name,url,hotPoint});
               }
            });
            writeJson(data);
            res.render('hot', { dataList: data });
        }else {
            res.json("error")
        }
        //输出内容
        //退出该phantom实例
        await instance.exit();
    }());
    function writeJson(params){
        //现将json文件读出来
        fs.readFile('./data/hot.json',function(err,data){
            if(err){
                return console.error(err);
            }
            var str = JSON.stringify(Object.assign(params,JSON.parse(data.toString()))).toString();
            fs.writeFile('./data/hot.json',str,function(err){
                if(err){
                    console.error(err);
                }
                console.log('----------新增成功-------------');
            })
        })
    }

})
module.exports = router;
